<!DOCTYPE html><html lang="en"><head><title>src/text</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="src/text"><meta name="groc-project-path" content="src/text.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/text.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright 2015-2021 JC Fisher
based heavily on code from socialcalc</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">import</span> {
  d1900,
  MinutesInHour,
  MinutesInDay,
  SecondsInMinute,
  SecondsInDay,
  SecondsInHour,
  AllowedDates,
  DayNames,
  DayNames3,
  MonthNames,
  MonthNames3,
  AM,
  AM1,
  PM,
  PM1,
  DefaultCurrency,
  SeparatorChar,
  DecimalChar,
  AllowedColors
} <span class="hljs-keyword">from</span> <span class="hljs-string">"./constants"</span>;

<span class="hljs-keyword">import</span> parsedate <span class="hljs-keyword">from</span> <span class="hljs-string">"./parsedate"</span>;

<span class="hljs-keyword">let</span> FormatNumber = {};

FormatNumber.format_definitions = {}; <span class="hljs-comment">// Parsed formats are stored here globally</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Other constants</p></div></div><div class="code"><div class="wrapper">FormatNumber.commands = {
  copy: <span class="hljs-number">1</span>,
  color: <span class="hljs-number">2</span>,
  integer_placeholder: <span class="hljs-number">3</span>,
  fraction_placeholder: <span class="hljs-number">4</span>,
  decimal: <span class="hljs-number">5</span>,
  currency: <span class="hljs-number">6</span>,
  general: <span class="hljs-number">7</span>,
  separator: <span class="hljs-number">8</span>,
  date: <span class="hljs-number">9</span>,
  comparison: <span class="hljs-number">10</span>,
  section: <span class="hljs-number">11</span>,
  style: <span class="hljs-number">12</span>
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr>
<p>result = FormatNumber.formatNumberWithFormat = function(rawvalue, format_string, currency_char)</p>
<hr></div></div><div class="code"><div class="wrapper">FormatNumber.formatNumberWithFormat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">
  rawvalue,
  format_string,
  currency_char
</span>) </span>{
  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> op, operandstr, fromend, cval, operandstrlc;
  <span class="hljs-keyword">var</span> startval, estartval;
  <span class="hljs-keyword">var</span> hrs, mins, secs, ehrs, emins, esecs, ampmstr, ymd;
  <span class="hljs-keyword">var</span> minOK, mpos, mspos;
  <span class="hljs-keyword">var</span> result = <span class="hljs-string">""</span>;
  <span class="hljs-keyword">var</span> format;
  <span class="hljs-keyword">var</span> section, gotcomparison, compop, compval, cpos, oppos;
  <span class="hljs-keyword">var</span> sectioninfo;
  <span class="hljs-keyword">var</span> i,
    decimalscale,
    scaledvalue,
    strvalue,
    strparts,
    integervalue,
    fractionvalue;
  <span class="hljs-keyword">var</span> integerdigits2,
    integerpos,
    fractionpos,
    textcolor,
    textstyle,
    separatorchar,
    decimalchar;
  <span class="hljs-keyword">var</span> value; <span class="hljs-comment">// working copy to change sign, etc.</span>

  rawvalue = rawvalue - <span class="hljs-number">0</span>; <span class="hljs-comment">// make sure a number</span>
  value = rawvalue;
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(value)) <span class="hljs-keyword">return</span> <span class="hljs-string">"NaN"</span>;

  <span class="hljs-keyword">var</span> negativevalue = value &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>; <span class="hljs-comment">// determine sign, etc.</span>
  <span class="hljs-keyword">if</span> (negativevalue) value = -value;
  <span class="hljs-keyword">var</span> zerovalue = value == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;

  currency_char = currency_char || DefaultCurrency;

  FormatNumber.parse_format_string(scfn.format_definitions, format_string); <span class="hljs-comment">// make sure format is parsed</span>
  format = scfn.format_definitions[format_string]; <span class="hljs-comment">// Get format structure</span>

  <span class="hljs-keyword">if</span> (!format) <span class="hljs-keyword">throw</span> <span class="hljs-string">"Format not parsed error."</span>;

  section = format.sectioninfo.length - <span class="hljs-number">1</span>; <span class="hljs-comment">// get number of sections - 1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>has comparisons - determine which section</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (format.hascomparison) {
    section = <span class="hljs-number">0</span>; <span class="hljs-comment">// set to which section we will use</span>
    gotcomparison = <span class="hljs-number">0</span>; <span class="hljs-comment">// this section has no comparison</span>
    <span class="hljs-keyword">for</span> (cpos = <span class="hljs-number">0</span>; ; cpos++) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scan for comparisons</p></div></div><div class="code"><div class="wrapper">      op = format.operators[cpos];
      operandstr = format.operands[cpos]; <span class="hljs-comment">// get next operator and operand</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>at end with no match</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (!op) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if comparison but no match</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (gotcomparison) {
          format_string = <span class="hljs-string">"General"</span>; <span class="hljs-comment">// use default of General</span>
          scfn.parse_format_string(scfn.format_definitions, format_string);
          format = scfn.format_definitions[format_string];
          section = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// if no comparision, matches on this section</span>
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>end of section</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (op == scfn.commands.section) {
        <span class="hljs-keyword">if</span> (!gotcomparison) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>no comparison, so it&#39;s a match</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">break</span>;
        }
        gotcomparison = <span class="hljs-number">0</span>;
        section++; <span class="hljs-comment">// check out next one</span>
        <span class="hljs-keyword">continue</span>;
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>found a comparison - do we meet it?</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (op == scfn.commands.comparison) {
        i = operandstr.indexOf(<span class="hljs-string">":"</span>);
        compop = operandstr.substring(<span class="hljs-number">0</span>, i);
        compval = operandstr.substring(i + <span class="hljs-number">1</span>) - <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (
          (compop == <span class="hljs-string">"&lt;"</span> &amp;&amp; rawvalue &lt; compval) ||
          (compop == <span class="hljs-string">"&lt;="</span> &amp;&amp; rawvalue &lt;= compval) ||
          (compop == <span class="hljs-string">"="</span> &amp;&amp; rawvalue == compval) ||
          (compop == <span class="hljs-string">"&lt;&gt;"</span> &amp;&amp; rawvalue != compval) ||
          (compop == <span class="hljs-string">"&gt;="</span> &amp;&amp; rawvalue &gt;= compval) ||
          (compop == <span class="hljs-string">"&gt;"</span> &amp;&amp; rawvalue &gt; compval)
        ) {
          <span class="hljs-keyword">break</span>;
        }
        gotcomparison = <span class="hljs-number">1</span>;
      }
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section &gt; <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>more than one section (separated by &quot;;&quot;)
two sections</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (section == <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (negativevalue) {
        negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// sign will provided by section, not automatically</span>
        section = <span class="hljs-number">1</span>; <span class="hljs-comment">// use second section for negative values</span>
      } <span class="hljs-keyword">else</span> {
        section = <span class="hljs-number">0</span>; <span class="hljs-comment">// use first for all others</span>
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section == <span class="hljs-number">2</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>three sections</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (negativevalue) {
        negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// sign will provided by section, not automatically</span>
        section = <span class="hljs-number">1</span>; <span class="hljs-comment">// use second section for negative values</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zerovalue) {
        section = <span class="hljs-number">2</span>; <span class="hljs-comment">// use third section for zero values</span>
      } <span class="hljs-keyword">else</span> {
        section = <span class="hljs-number">0</span>; <span class="hljs-comment">// use first for positive</span>
      }
    }
  }

  sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// look at values for our section</span>

  <span class="hljs-keyword">if</span> (sectioninfo.commas &gt; <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scale by thousands</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sectioninfo.commas; i++) {
      value /= <span class="hljs-number">1000</span>;
    }
  }
  <span class="hljs-keyword">if</span> (sectioninfo.percent &gt; <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>do percent scaling</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sectioninfo.percent; i++) {
      value *= <span class="hljs-number">100</span>;
    }
  }

  decimalscale = <span class="hljs-number">1</span>; <span class="hljs-comment">// cut down to required number of decimal digits</span>
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sectioninfo.fractiondigits; i++) {
    decimalscale *= <span class="hljs-number">10</span>;
  }
  scaledvalue = <span class="hljs-built_in">Math</span>.floor(value * decimalscale + <span class="hljs-number">0.5</span>);
  scaledvalue = scaledvalue / decimalscale;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> scaledvalue != <span class="hljs-string">"number"</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"NaN"</span>;
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(scaledvalue)) <span class="hljs-keyword">return</span> <span class="hljs-string">"NaN"</span>;

  strvalue = scaledvalue + <span class="hljs-string">""</span>; <span class="hljs-comment">// convert to string (Number.toFixed doesn't do all we need)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>  strvalue = value.toFixed(sectioninfo.fractiondigits); // cut down to required number of decimal digits
and convert to string</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (
    scaledvalue == <span class="hljs-number">0</span> &amp;&amp;
    (sectioninfo.fractiondigits || sectioninfo.integerdigits)
  ) {
    negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// no "-0" unless using multiple sections or General</span>
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>converted to scientific notation</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (strvalue.indexOf(<span class="hljs-string">"e"</span>) &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> rawvalue + <span class="hljs-string">""</span>; <span class="hljs-comment">// Just return plain converted raw value</span>
  }

  strparts = strvalue.match(<span class="hljs-regexp">/^\+{0,1}(\d*)(?:\.(\d*)){0,1}$/</span>); <span class="hljs-comment">// get integer and fraction parts</span>
  <span class="hljs-keyword">if</span> (!strparts) <span class="hljs-keyword">return</span> <span class="hljs-string">"NaN"</span>; <span class="hljs-comment">// if not a number</span>
  integervalue = strparts[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">if</span> (!integervalue || integervalue == <span class="hljs-string">"0"</span>) integervalue = <span class="hljs-string">""</span>;
  fractionvalue = strparts[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">if</span> (!fractionvalue) fractionvalue = <span class="hljs-string">""</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>there are date placeholders</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (sectioninfo.hasdate) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>bad date</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (rawvalue &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"??-???-?? ??:??:??"</span>;
    }
    startval = (rawvalue - <span class="hljs-built_in">Math</span>.floor(rawvalue)) * SecondsInDay; <span class="hljs-comment">// get date/time parts</span>
    estartval = rawvalue * SecondsInDay; <span class="hljs-comment">// do elapsed time version, too</span>
    hrs = <span class="hljs-built_in">Math</span>.floor(startval / SecondsInHour);
    ehrs = <span class="hljs-built_in">Math</span>.floor(estartval / SecondsInHour);
    startval = startval - hrs * SecondsInHour;
    mins = <span class="hljs-built_in">Math</span>.floor(startval / <span class="hljs-number">60</span>);
    emins = <span class="hljs-built_in">Math</span>.floor(estartval / <span class="hljs-number">60</span>);
    secs = startval - mins * <span class="hljs-number">60</span>;
    decimalscale = <span class="hljs-number">1</span>; <span class="hljs-comment">// round appropriately depending if there is ss.0</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sectioninfo.fractiondigits; i++) {
      decimalscale *= <span class="hljs-number">10</span>;
    }
    secs = <span class="hljs-built_in">Math</span>.floor(secs * decimalscale + <span class="hljs-number">0.5</span>);
    secs = secs / decimalscale;
    esecs = <span class="hljs-built_in">Math</span>.floor(estartval * decimalscale + <span class="hljs-number">0.5</span>);
    esecs = esecs / decimalscale;
    <span class="hljs-keyword">if</span> (secs &gt;= <span class="hljs-number">60</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>handle round up into next second, minute, etc.</p></div></div><div class="code"><div class="wrapper">      secs = <span class="hljs-number">0</span>;
      mins++;
      emins++;
      <span class="hljs-keyword">if</span> (mins &gt;= <span class="hljs-number">60</span>) {
        mins = <span class="hljs-number">0</span>;
        hrs++;
        ehrs++;
        <span class="hljs-keyword">if</span> (hrs &gt;= <span class="hljs-number">24</span>) {
          hrs = <span class="hljs-number">0</span>;
          rawvalue++;
        }
      }
    }
    fractionvalue = secs - <span class="hljs-built_in">Math</span>.floor(secs) + <span class="hljs-string">""</span>; <span class="hljs-comment">// for "hh:mm:ss.000"</span>
    fractionvalue = fractionvalue.substring(<span class="hljs-number">2</span>); <span class="hljs-comment">// skip "0."</span>

    ymd = parsedate(rawvalue);
    ymd = {
      year: ymd.getFullYear(),
      month: ymd.getMonth() + <span class="hljs-number">1</span>,
      day: ymd.getDate()
    };

    minOK = <span class="hljs-number">0</span>; <span class="hljs-comment">// says "m" can be minutes if true</span>
    mspos = sectioninfo.sectionstart; <span class="hljs-comment">// m scan position in ops</span>
    <span class="hljs-keyword">for</span> (; ; mspos++) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scan for &quot;m&quot; and &quot;mm&quot; to see if any minutes fields, and am/pm</p></div></div><div class="code"><div class="wrapper">      op = format.operators[mspos];
      operandstr = format.operands[mspos]; <span class="hljs-comment">// get next operator and operand</span>
      <span class="hljs-keyword">if</span> (!op) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// don't go past end</span>
      <span class="hljs-keyword">if</span> (op == scfn.commands.section) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">if</span> (op == scfn.commands.date) {
        <span class="hljs-keyword">if</span> (
          (operandstr.toLowerCase() == <span class="hljs-string">"am/pm"</span> ||
            operandstr.toLowerCase() == <span class="hljs-string">"a/p"</span>) &amp;&amp;
          !ampmstr
        ) {
          <span class="hljs-keyword">if</span> (hrs &gt;= <span class="hljs-number">12</span>) {
            <span class="hljs-keyword">if</span> (hrs &gt; <span class="hljs-number">12</span>) hrs -= <span class="hljs-number">12</span>;
            ampmstr = operandstr.toLowerCase() == <span class="hljs-string">"a/p"</span> ? PM1 : PM; <span class="hljs-comment">// "P" : "PM";</span>
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (hrs === <span class="hljs-number">0</span>) hrs = <span class="hljs-number">12</span>;
            ampmstr = operandstr.toLowerCase() == <span class="hljs-string">"a/p"</span> ? AM1 : AM; <span class="hljs-comment">// "A" : "AM";</span>
          }
          <span class="hljs-keyword">if</span> (operandstr.indexOf(ampmstr) &lt; <span class="hljs-number">0</span>) ampmstr = ampmstr.toLowerCase(); <span class="hljs-comment">// have case match case in format</span>
        }
        <span class="hljs-keyword">if</span> (minOK &amp;&amp; (operandstr == <span class="hljs-string">"m"</span> || operandstr == <span class="hljs-string">"mm"</span>)) {
          format.operands[mspos] += <span class="hljs-string">"in"</span>; <span class="hljs-comment">// turn into "min" or "mmin"</span>
        }
        <span class="hljs-keyword">if</span> (operandstr.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">"h"</span>) {
          minOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// m following h or hh or [h] is minutes not months</span>
        } <span class="hljs-keyword">else</span> {
          minOK = <span class="hljs-number">0</span>;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op != scfn.commands.copy) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>copying chars can be between h and m</p></div></div><div class="code"><div class="wrapper">        minOK = <span class="hljs-number">0</span>;
      }
    }
    minOK = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (--mspos; ; mspos--) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scan other way for s after m</p></div></div><div class="code"><div class="wrapper">      op = format.operators[mspos];
      operandstr = format.operands[mspos]; <span class="hljs-comment">// get next operator and operand</span>
      <span class="hljs-keyword">if</span> (!op) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// don't go past end</span>
      <span class="hljs-keyword">if</span> (op == scfn.commands.section) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">if</span> (op == scfn.commands.date) {
        <span class="hljs-keyword">if</span> (minOK &amp;&amp; (operandstr == <span class="hljs-string">"m"</span> || operandstr == <span class="hljs-string">"mm"</span>)) {
          format.operands[mspos] += <span class="hljs-string">"in"</span>; <span class="hljs-comment">// turn into "min" or "mmin"</span>
        }
        <span class="hljs-keyword">if</span> (operandstr == <span class="hljs-string">"ss"</span>) {
          minOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// m before ss is minutes not months</span>
        } <span class="hljs-keyword">else</span> {
          minOK = <span class="hljs-number">0</span>;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op != scfn.commands.copy) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>copying chars can be between ss and m</p></div></div><div class="code"><div class="wrapper">        minOK = <span class="hljs-number">0</span>;
      }
    }
  }

  integerdigits2 = <span class="hljs-number">0</span>; <span class="hljs-comment">// init counters, etc.</span>
  integerpos = <span class="hljs-number">0</span>;
  fractionpos = <span class="hljs-number">0</span>;
  textcolor = <span class="hljs-string">""</span>;
  textstyle = <span class="hljs-string">""</span>;
  separatorchar = SeparatorChar;
  <span class="hljs-keyword">if</span> (separatorchar.indexOf(<span class="hljs-string">" "</span>) &gt;= <span class="hljs-number">0</span>)
    separatorchar = separatorchar.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">" "</span>);
  decimalchar = DecimalChar;
  <span class="hljs-keyword">if</span> (decimalchar.indexOf(<span class="hljs-string">" "</span>) &gt;= <span class="hljs-number">0</span>)
    decimalchar = decimalchar.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">" "</span>);

  oppos = sectioninfo.sectionstart;

  <span class="hljs-keyword">while</span> ((op = format.operators[oppos])) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>execute format</p></div></div><div class="code"><div class="wrapper">    operandstr = format.operands[oppos++]; <span class="hljs-comment">// get next operator and operand</span>

    <span class="hljs-keyword">if</span> (op == scfn.commands.copy) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>put char in result</p></div></div><div class="code"><div class="wrapper">      result += operandstr;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.color) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>set color</p></div></div><div class="code"><div class="wrapper">      textcolor = operandstr;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.style) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>set style</p></div></div><div class="code"><div class="wrapper">      textstyle = operandstr;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.integer_placeholder) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>insert number part</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">"-"</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      integerdigits2++;
      <span class="hljs-keyword">if</span> (integerdigits2 == <span class="hljs-number">1</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>first one</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (integervalue.length &gt; sectioninfo.integerdigits) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>see if integer wider than field</p></div></div><div class="code"><div class="wrapper">          <span class="hljs-keyword">for</span> (
            ;
            integerpos &lt; integervalue.length - sectioninfo.integerdigits;
            integerpos++
          ) {
            result += integervalue.charAt(integerpos);
            <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>see if this is a separator position</p></div></div><div class="code"><div class="wrapper">              fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
              <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
                result += separatorchar;
              }
            }
          }
        }
      }
      <span class="hljs-keyword">if</span> (
        integervalue.length &lt; sectioninfo.integerdigits &amp;&amp;
        integerdigits2 &lt;= sectioninfo.integerdigits - integervalue.length
      ) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>field is wider than value</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (operandstr == <span class="hljs-string">"0"</span> || operandstr == <span class="hljs-string">"?"</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>fill with appropriate characters</p></div></div><div class="code"><div class="wrapper">          result += operandstr == <span class="hljs-string">"0"</span> ? <span class="hljs-string">"0"</span> : <span class="hljs-string">" "</span>;
          <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>see if this is a separator position</p></div></div><div class="code"><div class="wrapper">            fromend = sectioninfo.integerdigits - integerdigits2;
            <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
              result += separatorchar;
            }
          }
        }
      } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>normal integer digit - add it</p></div></div><div class="code"><div class="wrapper">        result += integervalue.charAt(integerpos);
        <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>see if this is a separator position</p></div></div><div class="code"><div class="wrapper">          fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
            result += separatorchar;
          }
        }
        integerpos++;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.fraction_placeholder) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>add fraction part of number</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (fractionpos &gt;= fractionvalue.length) {
        <span class="hljs-keyword">if</span> (operandstr == <span class="hljs-string">"0"</span> || operandstr == <span class="hljs-string">"?"</span>) {
          result += operandstr == <span class="hljs-string">"0"</span> ? <span class="hljs-string">"0"</span> : <span class="hljs-string">" "</span>;
        }
      } <span class="hljs-keyword">else</span> {
        result += fractionvalue.charAt(fractionpos);
      }
      fractionpos++;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.decimal) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>decimal point</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">"-"</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      result += decimalchar;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.currency) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>currency symbol</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">"-"</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      result += operandstr;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.general) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>insert &quot;General&quot; conversion</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>*** Cut down number of significant digits to avoid floating point artifacts:</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (value != <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>only if non-zero</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">var</span> factor = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.LOG10E * <span class="hljs-built_in">Math</span>.log(value)); <span class="hljs-comment">// get integer magnitude as a power of 10</span>
        factor = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, <span class="hljs-number">13</span> - factor); <span class="hljs-comment">// turn into scaling factor</span>
        value = <span class="hljs-built_in">Math</span>.floor(factor * value + <span class="hljs-number">0.5</span>) / factor; <span class="hljs-comment">// scale positive value, round, undo scaling</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(value)) <span class="hljs-keyword">return</span> <span class="hljs-string">"NaN"</span>;
      }
      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">"-"</span>;
      }
      strvalue = value + <span class="hljs-string">""</span>; <span class="hljs-comment">// convert original value to string</span>
      <span class="hljs-keyword">if</span> (strvalue.indexOf(<span class="hljs-string">"e"</span>) &gt;= <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>converted to scientific notation</p></div></div><div class="code"><div class="wrapper">        result += strvalue;
        <span class="hljs-keyword">continue</span>;
      }
      strparts = strvalue.match(<span class="hljs-regexp">/^\+{0,1}(\d*)(?:\.(\d*)){0,1}$/</span>); <span class="hljs-comment">// get integer and fraction parts</span>
      integervalue = strparts[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (!integervalue || integervalue == <span class="hljs-string">"0"</span>) integervalue = <span class="hljs-string">""</span>;
      fractionvalue = strparts[<span class="hljs-number">2</span>];
      <span class="hljs-keyword">if</span> (!fractionvalue) fractionvalue = <span class="hljs-string">""</span>;
      integerpos = <span class="hljs-number">0</span>;
      fractionpos = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (integervalue.length) {
        <span class="hljs-keyword">for</span> (; integerpos &lt; integervalue.length; integerpos++) {
          result += integervalue.charAt(integerpos);
          <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>see if this is a separator position</p></div></div><div class="code"><div class="wrapper">            fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
              result += separatorchar;
            }
          }
        }
      } <span class="hljs-keyword">else</span> {
        result += <span class="hljs-string">"0"</span>;
      }
      <span class="hljs-keyword">if</span> (fractionvalue.length) {
        result += decimalchar;
        <span class="hljs-keyword">for</span> (; fractionpos &lt; fractionvalue.length; fractionpos++) {
          result += fractionvalue.charAt(fractionpos);
        }
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.date) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>date placeholder</p></div></div><div class="code"><div class="wrapper">      operandstrlc = operandstr.toLowerCase();
      <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"y"</span> || operandstrlc == <span class="hljs-string">"yy"</span>) {
        result += (ymd.year + <span class="hljs-string">""</span>).substring(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"yyyy"</span>) {
        result += ymd.year + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"d"</span>) {
        result += ymd.day + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"dd"</span>) {
        cval = <span class="hljs-number">1000</span> + ymd.day;
        result += (cval + <span class="hljs-string">""</span>).substr(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"ddd"</span>) {
        cval = <span class="hljs-built_in">Math</span>.floor(rawvalue + <span class="hljs-number">6</span>) % <span class="hljs-number">7</span>;
        result += DayNames3[cval];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"dddd"</span>) {
        cval = <span class="hljs-built_in">Math</span>.floor(rawvalue + <span class="hljs-number">6</span>) % <span class="hljs-number">7</span>;
        result += DayNames[cval];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"m"</span>) {
        result += ymd.month + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mm"</span>) {
        cval = <span class="hljs-number">1000</span> + ymd.month;
        result += (cval + <span class="hljs-string">""</span>).substr(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mmm"</span>) {
        result += MonthNames3[ymd.month - <span class="hljs-number">1</span>];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mmmm"</span>) {
        result += MonthNames[ymd.month - <span class="hljs-number">1</span>];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mmmmm"</span>) {
        result += MonthNames[ymd.month - <span class="hljs-number">1</span>].charAt(<span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"h"</span>) {
        result += hrs + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"h]"</span>) {
        result += ehrs + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mmin"</span>) {
        cval = <span class="hljs-number">1000</span> + mins + <span class="hljs-string">""</span>;
        result += cval.substr(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"mm]"</span>) {
        <span class="hljs-keyword">if</span> (emins &lt; <span class="hljs-number">100</span>) {
          cval = <span class="hljs-number">1000</span> + emins + <span class="hljs-string">""</span>;
          result += cval.substr(<span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
          result += emins + <span class="hljs-string">""</span>;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"min"</span>) {
        result += mins + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"m]"</span>) {
        result += emins + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"hh"</span>) {
        cval = <span class="hljs-number">1000</span> + hrs + <span class="hljs-string">""</span>;
        result += cval.substr(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"s"</span>) {
        cval = <span class="hljs-built_in">Math</span>.floor(secs);
        result += cval + <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"ss"</span>) {
        cval = <span class="hljs-number">1000</span> + <span class="hljs-built_in">Math</span>.floor(secs) + <span class="hljs-string">""</span>;
        result += cval.substr(<span class="hljs-number">2</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"am/pm"</span> || operandstrlc == <span class="hljs-string">"a/p"</span>) {
        result += ampmstr;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc == <span class="hljs-string">"ss]"</span>) {
        <span class="hljs-keyword">if</span> (esecs &lt; <span class="hljs-number">100</span>) {
          cval = <span class="hljs-number">1000</span> + <span class="hljs-built_in">Math</span>.floor(esecs) + <span class="hljs-string">""</span>;
          result += cval.substr(<span class="hljs-number">2</span>);
        } <span class="hljs-keyword">else</span> {
          cval = <span class="hljs-built_in">Math</span>.floor(esecs);
          result += cval + <span class="hljs-string">""</span>;
        }
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.section) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>end of section</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">break</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.comparison) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>ignore</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">continue</span>;
    } <span class="hljs-keyword">else</span> {
      result += <span class="hljs-string">"!! Parse error.!!"</span>;
    }
  }

  <span class="hljs-keyword">if</span> (textcolor) {
    result = <span class="hljs-string">'&lt;span style="color:'</span> + textcolor + <span class="hljs-string">';"&gt;'</span> + result + <span class="hljs-string">"&lt;/span&gt;"</span>;
  }
  <span class="hljs-keyword">if</span> (textstyle) {
    result = <span class="hljs-string">'&lt;span style="'</span> + textstyle + <span class="hljs-string">';"&gt;'</span> + result + <span class="hljs-string">"&lt;/span&gt;"</span>;
  }

  <span class="hljs-comment">//console.log(result)</span>

  <span class="hljs-keyword">return</span> result;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr>
<p>FormatNumber.parse_format_string(format_defs, format_string)</p>
<p>Takes a format string (e.g., &quot;#,##0.00_);(#,##0.00)&quot;) and fills in format_defs with the parsed info</p>
<p>format_defs
[&quot;#,##0.0&quot;]-&gt;{} - elements in the hash are one hash for each format
.operators-&gt;[] - array of operators from parsing the format string (each a number)
.operands-&gt;[] - array of corresponding operators (each usually a string)
.sectioninfo-&gt;[] - one hash for each section of the format
.start
.integerdigits
.fractiondigits
.commas
.percent
.thousandssep
.hasdates
.hascomparison - true if any section has [&lt;100], etc.</p>
<hr></div></div><div class="code"><div class="wrapper">FormatNumber.parse_format_string = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">format_defs, format_string</span>) </span>{
  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> format, section, sectioninfo;
  <span class="hljs-keyword">var</span> integerpart = <span class="hljs-number">1</span>; <span class="hljs-comment">// start out in integer part</span>
  <span class="hljs-keyword">var</span> lastwasinteger; <span class="hljs-comment">// last char was an integer placeholder</span>
  <span class="hljs-keyword">var</span> lastwasslash; <span class="hljs-comment">// last char was a backslash - escaping following character</span>
  <span class="hljs-keyword">var</span> lastwasasterisk; <span class="hljs-comment">// repeat next char</span>
  <span class="hljs-keyword">var</span> lastwasunderscore; <span class="hljs-comment">// last char was _ which picks up following char for width</span>
  <span class="hljs-keyword">var</span> inquote, quotestr; <span class="hljs-comment">// processing a quoted string</span>
  <span class="hljs-keyword">var</span> inbracket, bracketstr, bracketdata; <span class="hljs-comment">// processing a bracketed string</span>
  <span class="hljs-keyword">var</span> ingeneral, gpos; <span class="hljs-comment">// checks for characters "General"</span>
  <span class="hljs-keyword">var</span> ampmstr, part; <span class="hljs-comment">// checks for characters "A/P" and "AM/PM"</span>
  <span class="hljs-keyword">var</span> indate; <span class="hljs-comment">// keeps track of date/time placeholders</span>
  <span class="hljs-keyword">var</span> chpos; <span class="hljs-comment">// character position being looked at</span>
  <span class="hljs-keyword">var</span> ch; <span class="hljs-comment">// character being looked at</span>

  <span class="hljs-keyword">if</span> (format_defs[format_string]) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// already defined - nothing to do</span>

  format = { operators: [], operands: [], sectioninfo: [{}] }; <span class="hljs-comment">// create info structure for this format</span>
  format_defs[format_string] = format; <span class="hljs-comment">// add to other format definitions</span>

  section = <span class="hljs-number">0</span>; <span class="hljs-comment">// start with section 0</span>
  sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// get reference to info for current section</span>
  sectioninfo.sectionstart = <span class="hljs-number">0</span>; <span class="hljs-comment">// position in operands that starts this section</span>
  sectioninfo.integerdigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// number of integer-part placeholders</span>
  sectioninfo.fractiondigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// fraction placeholders</span>
  sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// commas encountered, to handle scaling</span>
  sectioninfo.percent = <span class="hljs-number">0</span>; <span class="hljs-comment">// times to scale by 100</span>

  <span class="hljs-keyword">for</span> (chpos = <span class="hljs-number">0</span>; chpos &lt; format_string.length; chpos++) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>parse</p></div></div><div class="code"><div class="wrapper">    ch = format_string.charAt(chpos); <span class="hljs-comment">// get next char to examine</span>
    <span class="hljs-keyword">if</span> (inquote) {
      <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">'"'</span>) {
        inquote = <span class="hljs-number">0</span>;
        format.operators.push(scfn.commands.copy);
        format.operands.push(quotestr);
        <span class="hljs-keyword">continue</span>;
      }
      quotestr += ch;
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (inbracket) {
      <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"]"</span>) {
        inbracket = <span class="hljs-number">0</span>;
        bracketdata = FormatNumber.parse_format_bracket(bracketstr);
        <span class="hljs-keyword">if</span> (bracketdata.operator == scfn.commands.separator) {
          sectioninfo.thousandssep = <span class="hljs-number">1</span>; <span class="hljs-comment">// explicit [,]</span>
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (bracketdata.operator == scfn.commands.date) {
          sectioninfo.hasdate = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">if</span> (bracketdata.operator == scfn.commands.comparison) {
          format.hascomparison = <span class="hljs-number">1</span>;
        }
        format.operators.push(bracketdata.operator);
        format.operands.push(bracketdata.operand);
        <span class="hljs-keyword">continue</span>;
      }
      bracketstr += ch;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasslash) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch);
      lastwasslash = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasasterisk) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch + ch + ch + ch + ch); <span class="hljs-comment">// do 5 of them since no real tabs</span>
      lastwasasterisk = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasunderscore) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(<span class="hljs-string">" "</span>);
      lastwasunderscore = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (ingeneral) {
      <span class="hljs-keyword">if</span> (<span class="hljs-string">"general"</span>.charAt(ingeneral) == ch.toLowerCase()) {
        ingeneral++;
        <span class="hljs-keyword">if</span> (ingeneral == <span class="hljs-number">7</span>) {
          format.operators.push(scfn.commands.general);
          format.operands.push(ch);
          ingeneral = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">continue</span>;
      }
      ingeneral = <span class="hljs-number">0</span>;
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>last char was part of a date placeholder</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (indate) {
      <span class="hljs-keyword">if</span> (indate.charAt(<span class="hljs-number">0</span>) == ch) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>another of the same char</p></div></div><div class="code"><div class="wrapper">        indate += ch; <span class="hljs-comment">// accumulate it</span>
        <span class="hljs-keyword">continue</span>;
      }
      format.operators.push(scfn.commands.date); <span class="hljs-comment">// something else, save date info</span>
      format.operands.push(indate);
      sectioninfo.hasdate = <span class="hljs-number">1</span>;
      indate = <span class="hljs-string">""</span>;
    }
    <span class="hljs-keyword">if</span> (ampmstr) {
      ampmstr += ch;
      part = ampmstr.toLowerCase();
      <span class="hljs-keyword">if</span> (
        part != <span class="hljs-string">"am/pm"</span>.substring(<span class="hljs-number">0</span>, part.length) &amp;&amp;
        part != <span class="hljs-string">"a/p"</span>.substring(<span class="hljs-number">0</span>, part.length)
      ) {
        ampstr = <span class="hljs-string">""</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (part == <span class="hljs-string">"am/pm"</span> || part == <span class="hljs-string">"a/p"</span>) {
        format.operators.push(scfn.commands.date);
        format.operands.push(ampmstr);
        ampmstr = <span class="hljs-string">""</span>;
      }
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"#"</span> || ch == <span class="hljs-string">"0"</span> || ch == <span class="hljs-string">"?"</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>placeholder</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (integerpart) {
        sectioninfo.integerdigits++;
        <span class="hljs-keyword">if</span> (sectioninfo.commas) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>comma inside of integer placeholders</p></div></div><div class="code"><div class="wrapper">          sectioninfo.thousandssep = <span class="hljs-number">1</span>; <span class="hljs-comment">// any number is thousands separator</span>
          sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// reset count of "thousand" factors</span>
        }
        lastwasinteger = <span class="hljs-number">1</span>;
        format.operators.push(scfn.commands.integer_placeholder);
        format.operands.push(ch);
      } <span class="hljs-keyword">else</span> {
        sectioninfo.fractiondigits++;
        format.operators.push(scfn.commands.fraction_placeholder);
        format.operands.push(ch);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"."</span>) {
      lastwasinteger = <span class="hljs-number">0</span>;
      format.operators.push(scfn.commands.decimal);
      format.operands.push(ch);
      integerpart = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch === <span class="hljs-string">"$"</span>) {
      lastwasinteger = <span class="hljs-number">0</span>;
      format.operators.push(scfn.commands.currency);
      format.operands.push(ch);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">","</span>) {
      <span class="hljs-keyword">if</span> (lastwasinteger) {
        sectioninfo.commas++;
      } <span class="hljs-keyword">else</span> {
        format.operators.push(scfn.commands.copy);
        format.operands.push(ch);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"%"</span>) {
      lastwasinteger = <span class="hljs-number">0</span>;
      sectioninfo.percent++;
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">'"'</span>) {
      lastwasinteger = <span class="hljs-number">0</span>;
      inquote = <span class="hljs-number">1</span>;
      quotestr = <span class="hljs-string">""</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"["</span>) {
      lastwasinteger = <span class="hljs-number">0</span>;
      inbracket = <span class="hljs-number">1</span>;
      bracketstr = <span class="hljs-string">""</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"\\"</span>) {
      lastwasslash = <span class="hljs-number">1</span>;
      lastwasinteger = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"*"</span>) {
      lastwasasterisk = <span class="hljs-number">1</span>;
      lastwasinteger = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">"_"</span>) {
      lastwasunderscore = <span class="hljs-number">1</span>;
      lastwasinteger = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">";"</span>) {
      section++; <span class="hljs-comment">// start next section</span>
      format.sectioninfo[section] = {}; <span class="hljs-comment">// create a new section</span>
      sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// get reference to info for current section</span>
      sectioninfo.sectionstart = <span class="hljs-number">1</span> + format.operators.length; <span class="hljs-comment">// remember where it starts</span>
      sectioninfo.integerdigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// number of integer-part placeholders</span>
      sectioninfo.fractiondigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// fraction placeholders</span>
      sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// commas encountered, to handle scaling</span>
      sectioninfo.percent = <span class="hljs-number">0</span>; <span class="hljs-comment">// times to scale by 100</span>
      integerpart = <span class="hljs-number">1</span>; <span class="hljs-comment">// reset for new section</span>
      lastwasinteger = <span class="hljs-number">0</span>;
      format.operators.push(scfn.commands.section);
      format.operands.push(ch);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch.toLowerCase() == <span class="hljs-string">"g"</span>) {
      ingeneral = <span class="hljs-number">1</span>;
      lastwasinteger = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch.toLowerCase() == <span class="hljs-string">"a"</span>) {
      ampmstr = ch;
      lastwasinteger = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"dmyhHs"</span>.indexOf(ch) &gt;= <span class="hljs-number">0</span>) {
      indate = ch;
    } <span class="hljs-keyword">else</span> {
      lastwasinteger = <span class="hljs-number">0</span>;
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch);
    }
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>last char was part of unsaved date placeholder</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (indate) {
    format.operators.push(scfn.commands.date);
    format.operands.push(indate);
    sectioninfo.hasdate = <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">return</span>;
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr>
<p>bracketdata = FormatNumber.parse_format_bracket(bracketstr)</p>
<p>Takes a bracket contents (e.g., &quot;RED&quot;, &quot;&gt;10&quot;) and returns an operator and operand</p>
<p>bracketdata-&gt;{}
.operator
.operand</p>
<hr></div></div><div class="code"><div class="wrapper">FormatNumber.parse_format_bracket = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bracketstr</span>) </span>{
  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> bracketdata = {};
  <span class="hljs-keyword">var</span> parts;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>currency</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (bracketstr.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">"$"</span>) {
    bracketdata.operator = scfn.commands.currency;
    parts = bracketstr.match(<span class="hljs-regexp">/^\$(.+?)(\-.+?){0,1}$/</span>);
    <span class="hljs-keyword">if</span> (parts) {
      bracketdata.operand = parts[<span class="hljs-number">1</span>] || DefaultCurrency || <span class="hljs-string">"$"</span>;
    } <span class="hljs-keyword">else</span> {
      bracketdata.operand = bracketstr.substring(<span class="hljs-number">1</span>) || DefaultCurrency || <span class="hljs-string">"$"</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bracketstr == <span class="hljs-string">"?$"</span>) {
    bracketdata.operator = scfn.commands.currency;
    bracketdata.operand = <span class="hljs-string">"[?$]"</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (AllowedColors[bracketstr.toUpperCase()]) {
    bracketdata.operator = scfn.commands.color;
    bracketdata.operand = AllowedColors[bracketstr.toUpperCase()];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((parts = bracketstr.match(<span class="hljs-regexp">/^style=([^']*)$/</span>))) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>[style=...]</p></div></div><div class="code"><div class="wrapper">    bracketdata.operator = scfn.commands.style;
    bracketdata.operand = parts[<span class="hljs-number">1</span>];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bracketstr == <span class="hljs-string">","</span>) {
    bracketdata.operator = scfn.commands.separator;
    bracketdata.operand = bracketstr;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (AllowedDates[bracketstr.toUpperCase()]) {
    bracketdata.operator = scfn.commands.date;
    bracketdata.operand = AllowedDates[bracketstr.toUpperCase()];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((parts = bracketstr.match(<span class="hljs-regexp">/^[&lt;&gt;=]/</span>))) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>comparison operator</p></div></div><div class="code"><div class="wrapper">    parts = bracketstr.match(<span class="hljs-regexp">/^([&lt;&gt;=]+)(.+)$/</span>); <span class="hljs-comment">// split operator and value</span>
    bracketdata.operator = scfn.commands.comparison;
    bracketdata.operand = parts[<span class="hljs-number">1</span>] + <span class="hljs-string">":"</span> + parts[<span class="hljs-number">2</span>];
  } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>unknown bracket</p></div></div><div class="code"><div class="wrapper">    bracketdata.operator = scfn.commands.copy;
    bracketdata.operand = <span class="hljs-string">"["</span> + bracketstr + <span class="hljs-string">"]"</span>;
  }

  <span class="hljs-keyword">return</span> bracketdata;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">text</span>(<span class="hljs-params">value, format, currency_char</span>) </span>{
  <span class="hljs-keyword">return</span> FormatNumber.formatNumberWithFormat(value, format, currency_char);
}</div></div></div></div></body></html>